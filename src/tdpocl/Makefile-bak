#/***************************************************************************
# *
# *       Module:    Makefile
# *      Program:    tdpocl
# *   Created by:    Darren Muff 21/07/2013
# *                  Copyright (c) 2013 [dstl]. All rights reserved.
# *
# *   Description:
# *      Makefile
# *
# *   CLASSIFICATION        :  UNCLASSIFIED
# *   Date of CLASSN        :  19/07/2013
# *
# * Permission is hereby granted, free of charge, to any person obtaining a
# * copy of this software and associated documentation files (the "Software"),
# * to deal in the Software without restriction, including without limitation
# * the rights to use, copy, modify, merge, publish, distribute, sublicense,
# * and/or sell copies of the Software, and to permit persons to whom the
# * Software is furnished to do so, subject to the following conditions:
# *
# * The above copyright notice and this permission notice shall be included
# * in all copies or substantial portions of the Software.
# *
# * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
# * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
# * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
# * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
# * DEALINGS IN THE SOFTWARE.
# *
# * THE SOFTWARE IN ITS ENTIRETY OR ANY SUBSTANTIAL PORTION SHOULD NOT BE
# * USED AS A WHOLE OR COMPONENT PART OF DERIVATIVE SOFTWARE THAT IS BEING
# * SOLD TO THE GOVERNMENT OF THE UNITED KINGDOM OF GREAT BRITAIN AND NORTHERN
# * IRELAND.
# *
# ***************************************************************************/

SRC     = tdp.c getUserInput.c createSurface.c topotrimSetup.c banner.c tdpcore.c getMemorySize.c oclSRPRanges.c OpenCLUtils.c

INCLUDE = tdpoclVersion.h colourCodes.h tdp.h tdpcore.h OpenCLUtils.h

UNAME      := $(shell uname)
VERSION    := $(shell `pwd`/GenGitVersion.sh)
INSTALLDIR := /usr/local/dstl
CURRDIR    := $(shell pwd)

# 'linux' is output for Linux system, 'darwin' for OS X
ifeq ($(UNAME), Darwin)
LIBS   = -framework OpenCL `$(INSTALLDIR)/bin/SIlib2-config --libs` -L/usr/local/lib
CFLAGS = -m64 -c `$(INSTALLDIR)/bin/SIlib2-config --cflags` -I/usr/local/include
else
LIBS = -L/usr/lib64 -lOpenCL `$(INSTALLDIR)/bin/SIlib2-config --libs` -L/usr/local/lib
CFLAGS = -m64 -c  `$(INSTALLDIR)/bin/SIlib2-config --cflags` -I/usr/local/include -I/usr/local/cuda-6.0/include
endif

OBJ = $(patsubst %.c, %.o, $(SRC))

CC = clang

all: tdpocl

tdpocl: $(OBJ) $(INCLUDE)
	$(CC) $(OBJ) $(LIBS) -o tdpocl-$(VERSION)
install:	tdpocl
	mkdir -p $(INSTALLDIR)/bin
	cp tdpocl-$(VERSION) $(INSTALLDIR)/bin/tdpocl-$(VERSION)
	rm -f $(INSTALLDIR)/bin/tdpocl
	ln -s $(INSTALLDIR)/bin/tdpocl-$(VERSION) $(INSTALLDIR)/bin/tdpocl
	mkdir -p $(INSTALLDIR)/OpenCLKernels
	rm -f $(INSTALLDIR)/OpenCLKernels/tdpKernel.cl
	ln -s $(CURRDIR)/tdpKernel.cl $(INSTALLDIR)/OpenCLKernels/tdpKernel.cl

%.o:	%.c $(INCLUDE)
	$(CC) $< $(CFLAGS) -o $@


clean: 
	rm -fr *.o
	rm -f tdpocl-*


